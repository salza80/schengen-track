<!DOCTYPE html>
<html lang="<%= I18n.locale %>">
<head>
  <!-- Preconnect to external domains for faster resource loading -->
  <!-- Google Fonts (critical for styling) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  
  <!-- Third-party services (ads, analytics, social) -->
  <link rel="preconnect" href="https://pagead2.googlesyndication.com">
  <link rel="preconnect" href="https://www.google-analytics.com">
  <link rel="preconnect" href="https://connect.facebook.net">
  <link rel="dns-prefetch" href="https://www.googletagmanager.com">
  
  <!-- Preload critical assets -->
  <link rel="preload" href="<%= asset_path('application.css') %>" as="style">

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="msvalidate.01" content="78EB2E60264CB939006FF5C07C8F2404">
  <meta http-equiv="content-language" content="<%= I18n.locale %>">
  <meta name="referrer" content="no-referrer-when-downgrade">
  <meta name="referrer-policy" content="no-referrer-when-downgrade">
  <% if request.host.include?('test.') %>
  <!-- Staging environment - prevent search engine indexing -->
  <meta name="robots" content="noindex, nofollow">
  <% end %>
  <meta name="description" content="<%= @meta_description || (content_for?(:description) ? yield(:description) : t('default_description')) %>" />
  <meta name="keywords" content="<%= t('keywords') %>">
  <meta property="og:type" content="<%= @og_type || 'website' %>" />
  <meta property="og:url" content="<%= @og_url || "https://#{request.host_with_port}#{request.path}" %>" />
  <meta property="og:title" content="<%= @meta_title || (content_for?(:title) ? t('title_with_content', content: yield(:title)) : t('default_title')) %>" />
  <meta property="og:description" content="<%= @meta_description || (content_for?(:description) ? yield(:description) : t('default_description')) %>" />
  <meta property="og:image" content="<%= @og_image || 'https://schengen-calculator.com/med.png' %>" />
  <meta property="og:image:width" content="1200" />
  <meta property="og:image:height" content="630" />
  <% if @og_site_name %><meta property="og:site_name" content="<%= @og_site_name %>" /><% end %>
  <% if @article_published_time %><meta property="article:published_time" content="<%= @article_published_time %>" /><% end %>
  <% if @article_modified_time %><meta property="article:modified_time" content="<%= @article_modified_time %>" /><% end %>
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="<%= @meta_title || (content_for?(:title) ? t('title_with_content', content: yield(:title)) : t('default_title')) %>" />
  <meta name="twitter:description" content="<%= @meta_description || (content_for?(:description) ? yield(:description) : t('default_description')) %>" />
  <meta name="twitter:image" content="<%= @og_image || 'https://schengen-calculator.com/med.png' %>" />


  <% canonical_tag = 'https://' + request.host_with_port + request.path %>
  <% locales_pattern = I18n.available_locales.map(&:to_s).join('|') %>
  <% alternate_path = '' %>
  <% alternate_path2 = '' %>
  <% alternate_path3 = '' %>
  <% alternate_path_other_lang = '' %>
  <% if request.path == '/en' || request.path == '/' || request.path == '/en/about' || request.path == '/about'  %>
    <% canonical_tag = 'https://' + request.host_with_port + '/' %>
    <% alternate_path = 'https://' + request.host_with_port + '/about' %>
    <% alternate_path2 = 'https://' + request.host_with_port + '/en/about' %>
    <% alternate_path3 = 'https://' + request.host_with_port + '/en' %>
  <% elsif request.path.starts_with?('/en/') %>
    <% canonical_tag = 'https://' + request.host_with_port + request.path.sub('/en/', '/') %>
    <% alternate_path2 = 'https://' + request.host_with_port + request.path %>
  <% elsif request.path =~ /^\/(#{locales_pattern})(\/.*)?$/ %>
    <% canonical_tag = 'https://' + request.host_with_port + request.path %>
    <% alternate_path_other_lang = canonical_tag %>
      <% if canonical_tag.end_with?('/about') %>
        <% alternate_path2 = canonical_tag %>
        <% canonical_tag = canonical_tag.sub(/\/about\z/, '') %>
        <% alternate_path_other_lang = canonical_tag %>
      <% end %>
      <% if canonical_tag =~ /\/(#{locales_pattern})\z/ %>
        <% alternate_path2 = canonical_tag + '/about' %>
      <% end %>
  <% else %>
    <% alternate_path2 = 'https://' + request.host_with_port + '/en' + request.path %>
  <% end %>

  <link rel="canonical" href="<%= canonical_tag %>" hreflang="<%= locale.to_s %>" />
  <% if alternate_path.present? %>
    <link rel="alternate" href="<%= alternate_path %>" hreflang="<%= locale.to_s %>"/>
  <% end %>
  <% if alternate_path2.present? %>
    <link rel="alternate" href="<%= alternate_path2 %>" hreflang="<%= locale.to_s %>"/>
  <% end %>
  <% if alternate_path3.present? %>
    <link rel="alternate" href="<%= alternate_path3 %>" hreflang="<%= locale.to_s %>"/>
  <% end %>

  <% I18n.available_locales.each do |locale| %>
    <% if locale != I18n.locale %>
      <% if alternate_path3.present? %>
        <% path_only = URI.parse(alternate_path3).path %>
        <% new_path = path_only.sub(/^\/(#{locales_pattern})(\/.*)?$/, "/#{locale}\\2") %>
        <% alternate_href_locale = alternate_path3.sub(path_only, new_path) %>
      
        <link rel="alternate" href="<%= alternate_href_locale %>" hreflang="<%= locale.to_s %>" />
      <% end %>

      <% if alternate_path_other_lang.present? %>
        <% path_only = URI.parse(alternate_path_other_lang).path %>
        <% new_path = path_only.sub(/^\/(#{locales_pattern})(\/.*)?$/, "/#{locale}\\2") %>
        <% alternate_href_locale = alternate_path_other_lang.sub(path_only, new_path) %>
      
        <link rel="alternate" href="<%= alternate_href_locale %>" hreflang="<%= locale.to_s %>" />
      <% end %>
    
      <% if alternate_path2.present? %>
        <% path_only = URI.parse(alternate_path2).path %>
        <% new_path = path_only.sub(/^\/(#{locales_pattern})(\/.*)?$/, "/#{locale}\\2") %>
        <% alternate_href_locale = alternate_path2.sub(path_only, new_path) %>
      
        <link rel="alternate" href="<%= alternate_href_locale %>" hreflang="<%= locale.to_s %>" />
      <% end %>
    <% end %>
  <% end %>
  
  <!-- Default to English for unmatched locales -->
  <link rel="alternate" href="https://<%= request.host_with_port %>/" hreflang="x-default" />

  <title><%= content_for?(:title) ? t('title_with_content', content: yield(:title)) : t('default_title') %></title>
  <%= favicon_link_tag asset_path('favicon.ico') %>
  
  <!-- Load Google Fonts asynchronously to avoid render blocking -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" media="print" onload="this.media='all'; this.onload=null;">
  <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap"></noscript>
  
  <!-- Favicon links for all devices and browsers -->
  <link rel="icon" type="image/x-icon" href="<%= asset_path('favicon.ico') %>">
  <link rel="icon" type="image/png" sizes="32x32" href="<%= asset_path('favicon-32x32.png') %>">
  <link rel="icon" type="image/png" sizes="16x16" href="<%= asset_path('favicon-16x16.png') %>">
  <link rel="apple-touch-icon" sizes="180x180" href="<%= asset_path('apple-touch-icon.png') %>">
  
  <%= stylesheet_link_tag 'application', media: 'all' %>
  <% if controller_name == 'days' %>
    <%= stylesheet_link_tag 'calendar', media: 'all' %>
  <% elsif controller_name == 'blogs' %>
    <%= stylesheet_link_tag 'blog', media: 'all' %>
  <% end %>
  <%= javascript_include_tag 'core', defer: true %>
  <% if controller_name == 'days' %>
    <%= javascript_include_tag 'calendar_bundle', defer: true %>
  <% elsif controller_name == 'visits' || controller_name == 'visas' %>
    <%= javascript_include_tag 'visits_bundle', defer: true %>
  <% end %>
  <%= csrf_meta_tags %>

  <!-- WebApplication Structured Data for SEO -->
  <% if controller_name == 'days' && action_name == 'index' %>
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebApplication",
      "name": "<%= t('common.schengen_calculator') %>",
      "url": "https://<%= request.host %>",
      "description": "<%= t('default_description') %>",
      "applicationCategory": "UtilityApplication",
      "operatingSystem": "Any",
      "browserRequirements": "Requires JavaScript",
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "USD"
      },
      "featureList": [
        "Track Schengen 90/180 day rule",
        "Visual calendar interface",
        "Multiple trip planning",
        "Visa holder support",
        "6 language support (EN, DE, ES, HI, TR, ZH)",
        "Free account and data sync"
      ],
      "inLanguage": ["en", "de", "es", "hi", "tr", "zh"]
    }
    </script>
  <% end %>
</head>
<body>

<%= render 'layouts/header' %>

<div class="container-fluid">
  <div class="row">
    <div class="col-lg-9">
      <div class="notice">
        <%= render 'layouts/notice' %>
      </div>
      <%= yield %>
    </div>
    <div class="col-lg-3">
      <%= render 'layouts/agoda' %>
    </div>
  </div>
</div>

<%= render 'layouts/footer' %>

<!-- Eruda mobile debugging console (131KB) -->
<!-- Commented out to improve staging performance (saves ~200ms load time) -->
<!-- To re-enable for debugging mobile issues, uncomment the lines below: -->
<%# if request.host.include?('test.schengen-calculator.com') %>
  <%#= tag.script src: "https://cdn.jsdelivr.net/npm/eruda" %>
  <%#= tag.script do %>
    <%# raw "eruda.init();" %>
  <%# end %>
<%# end %>

<!-- Lazy-load third-party scripts on user interaction or after load -->
<script>
  // Flag to ensure scripts only load once
  let scriptsLoaded = false;

  function loadThirdPartyScripts() {
    if (scriptsLoaded) return;
    scriptsLoaded = true;

    // Facebook SDK
    window.fbAsyncInit = function() {
      FB.init({
        appId: '<%= ENV['FACEBOOK_ID'] || Rails.application.secrets.facebook_id %>',
        autoLogAppEvents: true,
        xfbml: true,
        version: 'v19.0'
      });
    };

    (function(d, s, id){
       let js, fjs = d.getElementsByTagName(s)[0];
       if (d.getElementById(id)) {return;}
       js = d.createElement(s); js.id = id;
       js.src = "https://connect.facebook.net/en_US/sdk.js";
       fjs.parentNode.insertBefore(js, fjs);
     }(document, 'script', 'facebook-jssdk'));

    // Google AdSense
    const adsScript = document.createElement('script');
    adsScript.src = '//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js';
    adsScript.async = true;
    document.body.appendChild(adsScript);
    
    adsScript.onload = function() {
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-8290979932488448",
        enable_page_level_ads: true
      });
    };
  }

  // Load scripts after page is fully loaded and user interacts
  // Or automatically after 3 seconds if no interaction
  window.addEventListener('load', function() {
    let autoLoadTimer = setTimeout(loadThirdPartyScripts, 3000);
    
    // Load on first user interaction (click, scroll, touch, keydown)
    const events = ['click', 'scroll', 'touchstart', 'keydown', 'mousemove'];
    const loadOnInteraction = function() {
      clearTimeout(autoLoadTimer);
      loadThirdPartyScripts();
      events.forEach(event => {
        window.removeEventListener(event, loadOnInteraction);
      });
    };
    
    events.forEach(event => {
      window.addEventListener(event, loadOnInteraction, { once: true, passive: true });
    });
  });
</script>

</body>
</html>
