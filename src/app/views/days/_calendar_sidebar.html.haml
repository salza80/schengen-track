- sticky_sidebar = local_assigns.fetch(:sticky_sidebar, true)
- show_legend = local_assigns.fetch(:show_legend, true)
.calendar-sidebar{class: (sticky_sidebar ? 'sticky-top' : nil), style: (sticky_sidebar ? "top: 100px; max-height: calc(100vh - 150px); overflow-y: auto; z-index: 50;" : nil)}
  -# Status information (always show, with default values if no data)
  .sidebar-section.card.mb-2
    .card-header.bg-primary.text-white
      .d-flex.justify-content-between.align-items-start
        .flex-grow-1.mr-3
          %h6.mb-0
            %i.fa.fa-chart-line
            = t('days.current_status')
          %small.d-block.mt-1
            = t('common.as_of')
            = l(Date.today, format: :long)
        = link_to days_path(year: Date.today.year, month: Date.today.month, day: Date.today.day, locale: I18n.locale), class: "btn btn-outline-light btn-sm d-flex align-items-center", "aria-label": t('days.jump_to_today') do
          %i.fa.fa-calendar.mr-1.flex-shrink-0{"aria-hidden": "true"}
          %span= t('days.jump_to_today')
    .card-body.p-3
      .status-info{"aria-live": "polite", "aria-atomic": "true"}
        .mb-2
          %small.text-muted= t('days.days_used')
          .h5.mb-0
            %strong= @status_summary ? @status_summary[:current_days] : 0
            %span.text-muted / 90
            - if @status_summary
              %span.badge.ml-2{class: status_badge_class(@status_summary[:status]), title: (@status_summary[:status] == 'overstay' ? t('days.overstay_tooltip') : nil), data: (@status_summary[:status] == 'overstay' ? {toggle: 'tooltip', placement: 'top'} : {})}
                - if @status_summary[:status] == 'overstay'
                  %i.fa.fa-exclamation-triangle
                = t("days.status_#{@status_summary[:status]}")
              - if @status_summary[:in_waiting_period] && @status_summary[:outside_schengen]
                %span.badge.badge-warning.ml-2{title: t('days.waiting_period_tooltip'), data: {toggle: 'tooltip', placement: 'top'}}
                  %i.fa.fa-clock
                  = t('days.legend_waiting')
            - else
              %span.badge.badge-success.ml-2= t("days.status_safe")
        .mb-2
          %small.text-muted= t('days.days_remaining')
          .h5.mb-0{class: @status_summary ? "text-#{status_text_class(@status_summary[:status])}" : "text-success"}
            %strong= @status_summary ? @status_summary[:remaining_days] : 90
        - if current_person.visa_required?
          .mb-2.mt-3.pt-3.border-top
            .d-flex.justify-content-between.align-items-center.mb-2
              %small.text-muted= t('days.visa_status_label')
              - if controller_name != 'visits'
                = link_to visits_path(locale: I18n.locale), class: "btn btn-outline-primary btn-sm", "aria-label": t('days.go_to_visas') do
                  %i.fa.fa-passport.mr-1{"aria-hidden": "true"}
                  = t('days.go_to_visas')
            - if @status_summary && @status_summary[:visa_status]
              .h5.mb-0
                - if @status_summary[:visa_status] == 'ok'
                  %span.badge.badge-success{title: t('days.visa_ok_tooltip'), data: {toggle: 'tooltip', placement: 'top'}}
                    %i.fa.fa-check
                    = t('days.visa_status_ok')
                  - if @status_summary[:visa_entries_display]
                    %small.ml-2.text-muted
                      = @status_summary[:visa_entries_display]
                - elsif @status_summary[:visa_issue_type] == 'entry_limit_exceeded'
                  - if @status_summary[:visa_entries_display]
                    %strong.mr-2= @status_summary[:visa_entries_display]
                  %span.badge.badge-danger
                    %i.fa.fa-exclamation-triangle
                    = t('days.entry_limit_exceeded')
                - else
                  %span.badge.badge-danger
                    %i.fa.fa-exclamation-triangle
                    = t('days.visa_warning')
            - else
              .h5.mb-0
                %span.badge.badge-info
                  %i.fa.fa-info-circle
                  = t('days.no_visa_entered')
  -# Legend
  - if show_legend && (@show_sidebar_legend.nil? || @show_sidebar_legend)
    .sidebar-section.card
      .card-header.bg-dark.text-white
        %h6.mb-0
          %i.fa.fa-palette
          = t('days.legend')
      .card-body.p-2
        .legend-item.d-flex.align-items-center.mb-2
          .legend-color.outside-schengen.mr-2{style: "width: 30px; height: 30px; border-radius: 4px;"}
          %small= t('days.legend_outside')
        .legend-item.d-flex.align-items-center.mb-2
          .legend-color.in-schengen-safe.mr-2{style: "width: 30px; height: 30px; border-radius: 4px;"}
          %small= t('days.legend_safe')
        .legend-item.d-flex.align-items-center.mb-2
          .legend-color.overstay.mr-2{style: "width: 30px; height: 30px; border-radius: 4px;"}
          %small= t('days.legend_overstay')
        - if @overstay
          .legend-item.d-flex.align-items-center
            .legend-color.waiting-period.mr-2{style: "width: 30px; height: 30px; border-radius: 4px;"}
            %small= t('days.legend_waiting')
  -# Next entry options
  - if @next_entry_days && @next_entry_days.any?
    .sidebar-section.card.mb-2
      .card-header.bg-info.text-white
        %h6.mb-0
          %i.fa.fa-plane-arrival
          = t('days.next_entry_options')
      .card-body.p-2
        - @next_entry_days.each do |day|
          .next-entry-item.border-bottom.py-2.px-2
            .entry-date
              = link_to days_path(year: day.the_date.year, month: day.the_date.month, day: day.the_date.day, locale: I18n.locale), class: "d-inline-block next-entry-link-text" do
                %strong.text-primary
                  = t('days.from_date_onwards', date: l(day.the_date, format: :long))
            .entry-duration
              %small
                = t('days.stay_for_days', days: day.max_remaining_days)
                - if day.max_remaining_days == 90
                  %span.badge.badge-success.ml-1= t('days.full_stay')
            .entry-until
              %small.text-muted
                = t('days.until_date', date: l(day.the_date + (day.max_remaining_days - 1).days, format: :long))
  
  -# Buy Me a Coffee
  .sidebar-section.card.mt-2
    .card-body.text-center.py-3
      %a{href: "https://www.buymeacoffee.com/smclean17d", target: "_blank", rel: "noopener"}
        %img{src: "https://cdn.buymeacoffee.com/buttons/v2/default-yellow.png", alt: "Buy Me A Coffee", style: "height: 50px; width: auto;"}
  
  -# Help and resources link
  .sidebar-section.card.mt-2
    .card-body.text-center.py-3
      %small.text-muted.d-block.mb-2= t('days.need_help')
      = link_to about_path(locale: I18n.locale), class: "btn btn-outline-primary btn-sm" do
        %i.fa.fa-question-circle.mr-1
        = t('days.learn_about_rule')

